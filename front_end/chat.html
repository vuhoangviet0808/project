<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="stylesheet" href="./css/base.css">
    <link rel="stylesheet" href="./css/chat.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const chatBody = document.querySelector(".chat-body");
            const createRoomInput = document.getElementById("create-room-input");
            const joinRoomInput = document.getElementById("join-room-input");
            const createRoomBtn = document.getElementById("create-room-btn");
            const joinRoomBtn = document.getElementById("join-room-btn");
            const friendList = document.getElementById("friend-list");
            let selectedFriendUsername = null;

            const socket = new WebSocket('ws://localhost:8080');

            socket.onopen = () => {
                console.log("WebSocket connected.");
                const userId = localStorage.getItem("user_id");

                if (userId) {
                    socket.send(`listfr ${userId}`); // Request friend list
                } else {
                    console.error("User ID not found in sessionStorage.");
                }
            };

            socket.onmessage = (event) => {
                const response = event.data;
                console.log(response);

                if (response.startsWith("RETRIEVE_RESPONSE")) {
                    // Extract chat messages and display them
                    const messages = response.slice(9).split("\n").filter(line => line.trim() !== "");
                    chatBody.innerHTML = ""; // Clear the chat body

                    messages.forEach(message => {
                        // Parse each message: [timestamp] user: message
                        const match = message.match(/^\[(.+?)\] (.+?): (.+)$/);
                        if (match) {
                            const [_, timestamp, user, text] = match;

                            const messageElement = document.createElement("div");
                            messageElement.className = user === selectedFriendUsername ? "message received" : "message sent";

                            messageElement.innerHTML = `
                                <p><strong>${user}</strong>: ${text}</p>
                                <span class="timestamp">${timestamp}</span>
                            `;
                            chatBody.appendChild(messageElement);
                        }
                    });

                    // Scroll to the bottom of the chat body
                    chatBody.scrollTop = chatBody.scrollHeight;
                } else if (response.startsWith("LIST_FRIENDS_RESPONSE")) {
                    // Extract friend list and display them
                    const friends = response.slice(19).split("\n").filter(line => line.trim() !== "");
                    friendList.innerHTML = ""; // Clear the friend list

                    friends.forEach(friend => {
                        // Parse each friend: id:username
                        const [id, username] = friend.split(":");
                        if (id && username) {
                            const friendElement = document.createElement("div");
                            friendElement.className = "chat-item";
                            friendElement.textContent = username;
                            friendElement.dataset.friendId = id;
                            friendElement.dataset.friendUsername = username;
                            friendList.appendChild(friendElement);

                            friendElement.addEventListener("click", () => {
                                const userId = localStorage.getItem("user_id");
                                if (userId) {
                                    selectedFriendUsername = username;
                                    socket.send(`retrieve ${userId} ${id}`);
                                }
                            });
                        }
                    });
                }
            };

            createRoomBtn.addEventListener("click", () => {
                const roomName = createRoomInput.value.trim();
                const userId = localStorage.getItem("user_id");
                if (roomName && userId) {
                    socket.send(`create_room ${roomName} ${userId}`);
                    createRoomInput.value = ""; // Clear input
                } else {
                    alert("Please enter a room name and make sure you're logged in.");
                }
            });

            joinRoomBtn.addEventListener("click", () => {
                const roomId = joinRoomInput.value.trim();
                const userId = localStorage.getItem("user_id");
                if (roomId && userId) {
                    socket.send(`join_room ${roomId} ${userId}`);
                    joinRoomInput.value = ""; // Clear input
                } else {
                    alert("Please enter a valid room ID and make sure you're logged in.");
                }
            });

            socket.onerror = (error) => {
                console.error("WebSocket error:", error);
            };
        });
    </script>
</head>

<body>
    <div class="messenger">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>Cuong</h1> <br />
                <button class="add-friend-btn"><i class="fas fa-user-plus"></i></button>
            </div>
            <div class="room-actions">
                <!-- Input and button to create room -->
                <div>
                    <input type="text" id="create-room-input" placeholder="Enter Room Name">
                    <button id="create-room-btn">Create Room</button>
                </div>
                <!-- Input and button to join room -->
                <div>
                    <input type="number" id="join-room-input" placeholder="Enter Room ID">
                    <button id="join-room-btn">Join Room</button>
                </div>
            </div>
            <!-- Chat list -->
            <div class="chat-list" id="room-list">
                <!-- Chat rooms will be dynamically added here -->
            </div>
            <!-- Friend list -->
            <div class="chat-list" id="friend-list">
                <!-- Friends will be dynamically added here -->
            </div>
        </div>

        <!-- Chat Section -->
        <div class="chat">
            <div class="chat-header">
                <h3 id="room-name">Room Name</h3>
            </div>
            <div class="chat-body" id="chat-body">
                <!-- Chat messages will be dynamically added here -->
            </div>
            <div class="chat-footer">
                <textarea placeholder="Type a message..." id="message-input"></textarea>
                <button class="send-btn" id="send-btn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</body>

</html>